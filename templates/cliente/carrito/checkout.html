{% extends 'cliente/base_cliente.html' %}
{% load custom_filters %}

{% block title %}Checkout - Chofys Pet's{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <h1 style="color: #4a5568; margin-bottom: 30px;">Finalizar Compra</h1>
    
    <!-- Mensaje para usuarios no autenticados -->
    {% if not user.is_authenticated or not usuario_autenticado %}
    <div style="background: #f8d7da; padding: 25px; border-radius: 12px; border-left: 4px solid #dc3545; margin-bottom: 30px;">
        <h3 style="color: #721c24; margin-bottom: 15px;">‚ùå Acceso Denegado</h3>
        <p style="color: #721c24; margin-bottom: 20px;">
            Debes iniciar sesi√≥n para poder realizar una compra. Si no tienes cuenta, puedes crear una.
        </p>
        <div style="display: flex; gap: 15px;">
            <a href="{% url 'cliente:login_cliente' %}?next={% url 'cliente:checkout' %}" class="btn btn-warning">
                Iniciar Sesi√≥n
            </a>
            <a href="{% url 'cliente:registro_cliente' %}?next={% url 'cliente:checkout' %}" class="btn btn-primary">
                Crear Cuenta
            </a>
            <a href="{% url 'cliente:ver_carrito' %}" class="btn btn-secondary">
                Volver al Carrito
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- üî• NUEVO: Resumen r√°pido del carrito -->
    {% if user.is_authenticated and usuario_autenticado %}
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong style="color: #4a5568;">üõí Tu carrito tiene {{ carrito_total_items }} productos</strong><br>
                <span style="color: #718096; font-size: 0.9rem;">
                    {% if carrito_total_items == 1 %}
                        1 producto listo para comprar
                    {% else %}
                        {{ carrito_total_items }} productos listos para comprar
                    {% endif %}
                </span>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="{% url 'cliente:ver_carrito' %}" class="btn" style="background: #e2e8f0; color: #4a5568; padding: 8px 15px; font-size: 0.9rem;">
                    Ver Carrito
                </a>
                <a href="{% url 'cliente:index_cliente' %}" class="btn btn-primary" style="padding: 8px 15px; font-size: 0.9rem;">
                    Seguir Comprando
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- DEBUG TEMPORAL -->
    <div style="background: yellow; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
        <strong>üîç DEBUG CHECKOUT:</strong><br>
        Carrito items: {{ carrito|length }}<br>
        Total: ${{ total }}<br>
        Usuario autenticado: {{ usuario_autenticado|yesno:"S√≠,No" }}
    </div>
    
    <!-- Contenido principal (solo para usuarios autenticados) -->
    {% if user.is_authenticated and usuario_autenticado %}
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
        <!-- Informaci√≥n del cliente -->
        <div>
            <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <h2 style="color: #4a5568; margin-bottom: 20px;">Datos de Env√≠o</h2>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #4a5568; font-size: 1.1rem; margin-bottom: 10px;">Cliente</h3>
                    <p style="color: #2d3748; margin-bottom: 5px;">
                        <strong>{{ usuario.nombre }} {{ usuario.apepaterno }} {{ usuario.apematerno }}</strong>
                    </p>
                    <p style="color: #718096; margin-bottom: 5px;">{{ usuario.correo }}</p>
                    <p style="color: #718096;">Tel√©fono: {{ usuario.telefono }}</p>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #4a5568; font-size: 1.1rem; margin-bottom: 10px;">Direcci√≥n de Env√≠o</h3>
                    <p style="color: #2d3748; margin-bottom: 5px;">{{ usuario.domicilio }}</p>
                    <p style="color: #718096; margin-bottom: 5px;">
                        {{ usuario.ciudad }}, {{ usuario.estado }}
                    </p>
                    <p style="color: #718096;">C√≥digo Postal: {{ usuario.codigo_postal }}</p>
                </div>
                
                <div>
                    <a href="{% url 'cliente:perfil_usuario' %}" class="btn" style="background: #e2e8f0; color: #4a5568; width: 100%;">
                        Actualizar mis datos
                    </a>
                </div>
            </div>
            
            <!-- M√©todo de pago -->
            <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-top: 30px;">
                <h2 style="color: #4a5568; margin-bottom: 20px;">M√©todo de Pago</h2>
                
                <!-- üî• FORMULARIO CORREGIDO -->
                <form method="post" action="{% url 'cliente:procesar_pago' %}" id="payment-form">
                    {% csrf_token %}
                    
                    <!-- DEBUG del formulario -->
                    <div style="background: #f0f9ff; padding: 10px; margin-bottom: 15px; border-radius: 5px; border-left: 3px solid #1890ff;">
                        <small>üîç Form action: <code>{% url 'cliente:procesar_pago' %}</code></small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; color: #4a5568; font-weight: bold;">
                            Selecciona m√©todo de pago:
                        </label>
                        
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <input type="radio" name="metodo_pago" value="EFECTIVO" checked id="efectivo">
                                <div>
                                    <span style="color: #2d3748; font-weight: bold;">üí∞ Efectivo</span><br>
                                    <span style="color: #718096; font-size: 0.9rem;">Paga al momento de la entrega</span>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <input type="radio" name="metodo_pago" value="TARJETA" id="tarjeta">
                                <div>
                                    <span style="color: #2d3748; font-weight: bold;">üí≥ Tarjeta Cr√©dito/D√©bito</span><br>
                                    <span style="color: #718096; font-size: 0.9rem;">Pago seguro en l√≠nea</span>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                <input type="radio" name="metodo_pago" value="TRANSFERENCIA" id="transferencia">
                                <div>
                                    <span style="color: #2d3748; font-weight: bold;">üè¶ Transferencia Bancaria</span><br>
                                    <span style="color: #718096; font-size: 0.9rem;">Transferencia o dep√≥sito</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n de tarjeta (oculta por defecto) -->
                    <div id="tarjeta-info" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h3 style="color: #4a5568; font-size: 1rem; margin-bottom: 15px;">üí≥ Datos de la Tarjeta</h3>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #718096; font-size: 0.9rem;">N√∫mero de tarjeta</label>
                            <input type="text" placeholder="1234 5678 9012 3456" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; color: #718096; font-size: 0.9rem;">Fecha de expiraci√≥n</label>
                                <input type="text" placeholder="MM/AA" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                            </div>
                            
                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; color: #718096; font-size: 0.9rem;">CVV</label>
                                <input type="text" placeholder="123" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot√≥n de confirmaci√≥n -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <p style="color: #718096; font-size: 0.9rem; margin-bottom: 20px;">
                            ‚úÖ Al confirmar el pago, aceptas nuestros <a href="#" style="color: #667eea;">t√©rminos y condiciones</a>.
                            Recibir√°s una factura electr√≥nica en tu correo.
                        </p>
                        
                        <!-- üî• BOT√ìN PRINCIPAL CORREGIDO -->
                        <button type="submit" 
                                class="btn btn-success" 
                                style="width: 100%; padding: 16px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer;"
                                id="submit-payment">
                            ‚úÖ Confirmar y Pagar ${{ total }}
                        </button>
                        
                        <!-- üî• BOT√ìN ALTERNATIVO DE EMERGENCIA -->
                        <button type="button" 
                                onclick="forceSubmit()"
                                style="width: 100%; margin-top: 10px; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem;"
                                id="emergency-submit">
                            üö® [EMERGENCIA] Si el bot√≥n de arriba no funciona, haz clic AQU√ç
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Resumen del pedido -->
        <div>
            <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <h2 style="color: #4a5568; margin-bottom: 20px;">Resumen del Pedido</h2>
                
                <!-- Productos -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #4a5568; font-size: 1.1rem; margin-bottom: 15px;">üì¶ Productos en tu carrito</h3>
                    
                    {% for item_id, item in carrito.items %}
                    <div style="display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
                        <div>
                            <strong style="color: #2d3748;">{{ item.nombre }}</strong><br>
                            <span style="color: #718096; font-size: 0.9rem;">
                                {{ item.cantidad }} x ${{ item.precio }}
                            </span>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: #2d3748; font-weight: bold;">
                                ${{ item.precio|multiply:item.cantidad|floatformat:2 }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Desglose de precios con IVA -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">üí∞ Desglose Fiscal</h3>
                    
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #718096;">Subtotal (sin IVA):</span>
                            <span style="color: #2d3748;">${{ subtotal }}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #718096;">IVA (16%):</span>
                            <span style="color: #2d3748;">${{ iva }}</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                            <span style="color: #2d3748; font-weight: bold; font-size: 1.1rem;">Total a pagar:</span>
                            <span style="color: #2d3748; font-weight: bold; font-size: 1.1rem;">${{ total }}</span>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n de env√≠o estimado -->
                    <div style="margin-top: 25px; padding: 20px; background: #e6f7ff; border-radius: 8px; border-left: 4px solid #1890ff;">
                        <h3 style="color: #0066cc; font-size: 1rem; margin-bottom: 10px;">üöö Informaci√≥n de Env√≠o</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <span style="color: #595959; font-size: 0.9rem;">Cliente:</span><br>
                                <strong style="color: #262626;">{{ usuario.nombre }} {{ usuario.apepaterno }}</strong>
                            </div>
                            <div>
                                <span style="color: #595959; font-size: 0.9rem;">Tel√©fono:</span><br>
                                <strong style="color: #262626;">{{ usuario.telefono }}</strong>
                            </div>
                            <div>
                                <span style="color: #595959; font-size: 0.9rem;">Direcci√≥n:</span><br>
                                <strong style="color: #262626;">{{ usuario.domicilio }}</strong>
                            </div>
                            <div>
                                <span style="color: #595959; font-size: 0.9rem;">C√≥digo Postal:</span><br>
                                <strong style="color: #262626;">{{ usuario.codigo_postal }}</strong>
                            </div>
                        </div>
                        
                        <!-- Fecha estimada de entrega mejorada -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #91d5ff;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div style="font-size: 1.2rem;">üìÖ</div>
                                <div>
                                    <span style="color: #595959; font-size: 0.9rem;">Fecha estimada de entrega:</span><br>
                                    <strong style="color: #0066cc; font-size: 1.1rem;">
                                        {{ fecha_entrega_estimada }}
                                    </strong>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #f6ffed; border-radius: 5px;">
                                <p style="color: #52c41a; font-size: 0.85rem; margin: 5px 0;">
                                    ‚úÖ <strong>Env√≠o est√°ndar:</strong> 2-3 d√≠as h√°biles
                                </p>
                                <p style="color: #52c41a; font-size: 0.85rem; margin: 5px 0;">
                                    üè† <strong>Direcci√≥n:</strong> {{ usuario.domicilio }}
                                </p>
                                <p style="color: #52c41a; font-size: 0.85rem; margin: 5px 0;">
                                    üìû <strong>Contacto:</strong> {{ usuario.telefono }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Informaci√≥n adicional -->
                <div style="margin-top: 30px; padding: 20px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #22543d; font-size: 1rem; margin-bottom: 10px;">üìã Informaci√≥n Importante</h3>
                    <ul style="color: #38a169; padding-left: 20px; font-size: 0.9rem;">
                        <li>Recibir√°s confirmaci√≥n por correo electr√≥nico</li>
                        <li>Factura electr√≥nica incluida</li>
                        <li>Env√≠o gratuito en compras mayores a $500</li>
                        <li>Pol√≠tica de devoluci√≥n de 30 d√≠as</li>
                        <li>Despu√©s del pago, tu carrito se vaciar√° autom√°ticamente</li>
                    </ul>
                </div>
            </div>
            
            <!-- Volver al carrito -->
            <div style="margin-top: 20px; text-align: center;">
                <a href="{% url 'cliente:ver_carrito' %}" class="btn" style="background: #e2e8f0; color: #4a5568; width: 100%; padding: 12px;">
                    ‚Üê Volver al Carrito
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
// Funci√≥n para forzar el env√≠o del formulario
function forceSubmit() {
    console.log('üö® Bot√≥n de emergencia clickeado');
    
    const form = document.getElementById('payment-form');
    if (!form) {
        alert('Error: No se encontr√≥ el formulario');
        return;
    }
    
    // Verificar que haya un m√©todo de pago seleccionado
    const metodoSeleccionado = document.querySelector('input[name="metodo_pago"]:checked');
    if (!metodoSeleccionado) {
        alert('Por favor selecciona un m√©todo de pago primero');
        return;
    }
    
    console.log('üì§ Forzando env√≠o del formulario...');
    console.log('M√©todo de pago seleccionado:', metodoSeleccionado.value);
    
    // Mostrar confirmaci√≥n
    if (confirm(`¬øConfirmas el pago de ${{ total }} con ${metodoSeleccionado.value}?`)) {
        // Enviar el formulario
        form.submit();
    }
}

// JavaScript principal
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç Checkout cargado correctamente');
    
    // 1. Mostrar/ocultar informaci√≥n de tarjeta
    const tarjetaRadio = document.querySelector('input[value="TARJETA"]');
    const tarjetaInfo = document.getElementById('tarjeta-info');
    
    if (tarjetaRadio && tarjetaInfo) {
        document.querySelectorAll('input[name="metodo_pago"]').forEach(radio => {
            radio.addEventListener('change', function() {
                tarjetaInfo.style.display = this.value === 'TARJETA' ? 'block' : 'none';
            });
        });
    }
    
    // 2. Manejar el formulario principal
    const form = document.getElementById('payment-form');
    const submitBtn = document.getElementById('submit-payment');
    
    if (form && submitBtn) {
        console.log('‚úÖ Formulario y bot√≥n encontrados');
        
        form.addEventListener('submit', function(e) {
            console.log('üéØ Formulario envi√°ndose...');
            
            // Verificar m√©todo de pago seleccionado
            const metodoPago = document.querySelector('input[name="metodo_pago"]:checked');
            if (!metodoPago) {
                alert('Por favor selecciona un m√©todo de pago');
                e.preventDefault();
                return false;
            }
            
            console.log(`‚úÖ M√©todo de pago: ${metodoPago.value}`);
            
            // Confirmaci√≥n final
            if (!confirm(`¬øConfirmas el pago de ${{ total }}?\n\nM√©todo: ${metodoPago.value}\n\nTu pedido llegar√° aproximadamente el {{ fecha_entrega_estimada }}`)) {
                console.log('‚ùå Pago cancelado por el usuario');
                e.preventDefault();
                return false;
            }
            
            console.log('‚úÖ Pago confirmado, enviando formulario...');
            return true;
        });
        
        // Tambi√©n agregar evento al bot√≥n por si acaso
        submitBtn.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è Bot√≥n principal clickeado');
            // No hacer nada extra, dejar que el form maneje el submit
        });
    }
    
    // 3. Depuraci√≥n: Mostrar informaci√≥n del formulario
    console.log('üìã Informaci√≥n del formulario:');
    console.log('  - ID:', form ? form.id : 'No encontrado');
    console.log('  - Action:', form ? form.action : 'N/A');
    console.log('  - Method:', form ? form.method : 'N/A');
    console.log('  - Elementos:', form ? form.elements.length : 'N/A');
    
    // 4. Verificar que el CSRF token est√© presente
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
    console.log('  - CSRF Token:', csrfToken ? '‚úÖ Presente' : '‚ùå Faltante');
});
</script>
{% endblock %}
{% endblock %}